// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum StockMovementType {
  IN @map("in")
  OUT @map("out")
}

enum TransactionType {
  SALE @map("sale")
  RETURN @map("return")
  PURCHASE @map("purchase")
  MANUAL @map("manual")
}

enum Unit {
  PC @map("pc")
  KG @map("kg")
}

model Product {
  id             Int      @id @default(autoincrement())
  name           String
  costPerUnit    Float
  soldBy         Unit
  sellingPrice   Int
  addedBy        String
  categoryId     Int
  branchId       Int
  createdAt      DateTime @default(now())

  category       Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  branch         Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  stock          Stock[]
  StockSnapshot   StockSnapshot[]
  transactionsDetails TransactionDetail[]
  TransactionDetailSnapshot TransactionDetailSnapshot[]

  @@index([categoryId])
  @@index([branchId])
}


model Category {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  createdAt DateTime   @default(now())
  product  Product[]
}

model Branch {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  createdAt    DateTime      @default(now())
  product     Product[]
  transactionsDetails TransactionDetail[]
  TransactionDetailSnapshot TransactionDetailSnapshot[]
}

model Stock {
  id           Int      @id @default(autoincrement())
  productId    Int
  quantity     Float
  stockAddedAt DateTime @default(now())
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([stockAddedAt])
}

model StockSnapshot {
  id           Int      @id @default(autoincrement())
  productId    Int
  quantity     Float
  archivedAt   DateTime @default(now())
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Transaction {
  id                  Int                 @id @default(autoincrement())
  transactionDetails  TransactionDetail[]
  totalPrice          Int
  transactionDate     DateTime            @default(now())
  TransactionDetailSnapshot TransactionDetailSnapshot[]
}

model TransactionDetail {
  id               Int      @id @default(autoincrement())
  productId        Int
  branchId         Int
  transactionId    Int
  stockSold        Float
  payment          Float
  transactionDate  DateTime @default(now())

  product          Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  branch           Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  transaction      Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branchId])
  @@index([transactionId])
  @@index([branchId, transactionDate])
  @@index([productId, transactionDate])
}

model TransactionDetailSnapshot {
  id               Int      @id @default(autoincrement())
  productId        Int
  branchId         Int
  transactionId    Int
  stockSold        Float
  payment          Float
  ArchiveAt  DateTime @default(now())
  product          Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  branch           Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  transaction      Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branchId])
  @@index([transactionId])
  @@index([branchId, ArchiveAt])
  @@index([productId, ArchiveAt])
}


model Monthly_Overall_Stats {
  id            Int      @id @default(autoincrement())
  date          DateTime @unique
  profit        Float
  totalSales    Float
}
